define(["utility"],function(e){var t={local:"LOCAL",get:function(e,t,n,r,i,s,o){this._send("GET",e,t,n,r,i,s,o)},post:function(e,t,n,r,i,s,o){this._send("POST",e,t,n,r,i,s,o)},put:function(e,t,n,r,i,s,o){this._send("PUT",e,t,n,r,i,s,o)},"delete":function(e,t,n,r,i,s,o){this._send("DELETE",e,t,n,r,i,s,o)},_send:function(t,n,r,i,s,o,u,a){if(window.localStorage.DEBUG===this.local){this._loadJSONData(n,i,s);return}var f=JSON.parse(localStorage.getItem("event_nosecret"));(!f||f&&f.expires_time<(new Date).getTime())&&$.ajax({type:"GET",url:"http://"+window.frontJSHost+"/oauth/oauth2/token?grant_type=client_credential"+window.secretID,async:!1,dataType:"json",success:function(e){e.expires_time=(new Date).getTime()+e.expires_in*1e3,localStorage.setItem("event_nosecret",JSON.stringify(e)),f=e}}),Object.prototype.toString.call(r)=="[object String]"&&(r=JSON.parse(r));var l="application/x-www-form-urlencoded; charset=utf-8";if(t==="POST"||t==="PUT")l="application/json;",r=JSON.stringify(r);var c=this;c.isPaging=u,u||this._showLoading();var h=a;h||(h=f.access_token),$.ajax({type:t,url:n.indexOf("?")>0?n+"&access_token="+h:n+"?access_token="+h,data:r,dataType:"json",timeout:6e4,contentType:l,beforeSend:function(e,t){e.setRequestHeade&&e.setRequestHeader("Authorization","Bearer "+h)},success:function(e){c._hideLoading(),s&&Object.prototype.toString.call(s)==="[object Function]"&&s.apply(i,[e])},error:function(t,n){c._hideLoading();if(t.status===401)$.ajax({type:"GET",url:"http://"+window.frontJSHost+"/oauth/oauth2/token?grant_type=client_credential"+window.secretID,async:!1,dataType:"json",success:function(e){e.expires_time=(new Date).getTime()+e.expires_in*1e3,localStorage.setItem("event_nosecret",JSON.stringify(e))}});else if(o&&Object.prototype.toString.call(o)==="[object Function]")o.apply(i,[t,n]);else try{e.showToast("错误："+JSON.parse(t.responseText).message)}catch(r){e.showToast("服务器出错，类型："+n)}}})},_showLoading:function(){e.showLoading()},_hideLoading:function(){e.hideLoading()},loadError:function(e){},_loadJSONData:function(t,n,r){var i=t.substr(t.lastIndexOf("/")+1);i.indexOf("?")>0&&(i=i.substr(0,i.indexOf("?"))),i="data/"+i+".json";var s="test_data_"+(new Date).getTime();$("body").append('<script type="text/javascript">testDataKey="'+s+'"</script>'),e.loadJS(i),setTimeout(function(){r.apply(n,[window[s]])},10)}};return t});