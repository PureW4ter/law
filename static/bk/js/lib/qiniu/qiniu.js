function QiniuJsSDK(){this.detectIEVersion=function(){var e=4,t=document.createElement("div"),n=t.getElementsByTagName("i");while(t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",n[0])e++;return e>4?e:!1},this.isImage=function(e){var t,n="",r=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),n=t[1].toLowerCase();for(var s=0,o=r.length;s<o;s++)if(n===r[s])return!0;return!1},this.getFileExtension=function(e){var t=e.split("."),n;return t.length===1||t[0]===""&&t.length===2?n="":n=t.pop().toLowerCase(),n},this.utf8_encode=function(e){if(e===null||typeof e=="undefined")return"";var t=e+"",n="",r,i,s=0;r=i=0,s=t.length;for(var o=0;o<s;o++){var u=t.charCodeAt(o),a=null;if(u<128)i++;else if(u>127&&u<2048)a=String.fromCharCode(u>>6|192,u&63|128);else if(u&63488^!0)a=String.fromCharCode(u>>12|224,u>>6&63|128,u&63|128);else{if(u&64512^!0)throw new RangeError("Unmatched trail surrogate at "+o);var f=t.charCodeAt(++o);if(f&64512^!0)throw new RangeError("Unmatched lead surrogate at "+(o-1));u=((u&1023)<<10)+(f&1023)+65536,a=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,u&63|128)}a!==null&&(i>r&&(n+=t.slice(r,i)),n+=a,r=i=o+1)}return i>r&&(n+=t.slice(r,s)),n},this.base64_encode=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n,r,i,s,o,u,a,f,l=0,c=0,h="",p=[];if(!e)return e;e=this.utf8_encode(e+"");do n=e.charCodeAt(l++),r=e.charCodeAt(l++),i=e.charCodeAt(l++),f=n<<16|r<<8|i,s=f>>18&63,o=f>>12&63,u=f>>6&63,a=f&63,p[c++]=t.charAt(s)+t.charAt(o)+t.charAt(u)+t.charAt(a);while(l<e.length);h=p.join("");switch(e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(e){var t={};return window.XMLHttpRequest?t=new XMLHttpRequest:t=new ActiveXObject("Microsoft.XMLHTTP"),t},this.parseJSON=function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e);if(e===null)return e;if(typeof e=="string"){e=this.trim(e);if(e&&/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return function(){return e}()}},this.trim=function(e){return e===null?"":this.trim.call(e)};var e=this;this.uploader=function(t){if(!t.domain)throw"uptoken_url or domain is required!";if(!t.browse_button)throw"browse_button is required!";var n={},r=t.init&&t.init.Error,i=t.init&&t.init.FileUploaded;t.init.Error=function(){},t.init.FileUploaded=function(){},e.uptoken_url=t.uptoken_url,e.token="",e.key_handler=typeof t.init.Key=="function"?t.init.Key:"",this.domain=t.domain;var s="",o=function(){var n=e.detectIEVersion(),r,i,s,o=mOxie.Env.browser==="Safari"&&mOxie.Env.version<=5&&mOxie.Env.os==="Windows"&&mOxie.Env.osVersion==="7"||mOxie.Env.browser==="Safari"&&mOxie.Env.os==="iOS"&&mOxie.Env.osVersion==="7";n&&n<=9&&t.chunk_size&&t.runtimes.indexOf("flash")>=0?t.chunk_size=0:o?t.chunk_size=0:(r=20,i=4<<r,s=plupload.parseSize(t.chunk_size),s>i&&(t.chunk_size=i))};o();var u=function(){if(!t.uptoken){var n=e.createAjax();n.open("GET",e.uptoken_url,!0),n.setRequestHeader("If-Modified-Since","0"),n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){var t=e.parseJSON(n.responseText);e.token=t.uptoken}},n.send()}else e.token=t.uptoken},a=function(n,r,i){var s="",o=!1;if(!t.save_key){o=n.getOption&&n.getOption("unique_names"),o=o||n.settings&&n.settings.unique_names;if(o){var u=e.getFileExtension(r.name);s=u?r.id+"."+u:r.id}else typeof i=="function"?s=i(n,r):s=r.name}return s};plupload.extend(n,t,{url:"http://up.qiniu.com",multipart_params:{token:""}});var f=new plupload.Uploader(n);return f.bind("Init",function(e,t){u()}),f.init(),f.bind("FilesAdded",function(e,t){var n=e.getOption&&e.getOption("auto_start");n=n||e.settings&&e.settings.auto_start,n&&plupload.each(t,function(t,n){e.start()}),e.refresh()}),f.bind("BeforeUpload",function(n,r){s="";var i=function(n,r,i){var s;t.save_key?s={token:e.token}:s={key:a(n,r,i),token:e.token};var o=t.x_vars;if(o!==undefined&&typeof o=="object")for(var u in o)o.hasOwnProperty(u)&&(typeof o[u]=="function"?s["x:"+u]=o[u](n,r):typeof o[u]!="object"&&(s["x:"+u]=o[u]));n.setOption({url:"http://up.qiniu.com/",multipart:!0,chunk_size:undefined,multipart_params:s})},o=n.getOption&&n.getOption("chunk_size");o=o||n.settings&&n.settings.chunk_size;if(f.runtime==="html5"&&o)if(r.size<o)i(n,r,e.key_handler);else{var u=localStorage.getItem(r.name),l=o;if(u){u=JSON.parse(u);var c=(new Date).getTime(),h=u.time||0,p=864e5;c-h<p?u.percent!==100?r.size===u.total?(r.percent=u.percent,r.loaded=u.offset,s=u.ctx,u.offset+l>r.size&&(l=r.size-u.offset)):localStorage.removeItem(r.name):localStorage.removeItem(r.name):localStorage.removeItem(r.name)}n.setOption({url:"http://up.qiniu.com/mkblk/"+l,multipart:!1,chunk_size:o,required_features:"chunks",headers:{Authorization:"UpToken "+e.token},multipart_params:{}})}else i(n,r,e.key_handler)}),f.bind("ChunkUploaded",function(t,n,r){var i=e.parseJSON(r.response);s=s?s+","+i.ctx:i.ctx;var o=r.total-r.offset,u=t.getOption&&t.getOption("chunk_size");u=u||t.settings&&t.settings.chunk_size,o<u&&t.setOption({url:"http://up.qiniu.com/mkblk/"+o}),localStorage.setItem(n.name,JSON.stringify({ctx:s,percent:n.percent,total:r.total,offset:r.offset,time:(new Date).getTime()}))}),f.bind("Error",function(t){return function(n,r){var i="",s=r.file;if(s){switch(r.code){case plupload.FAILED:i="ä¸Šä¼ å¤±è´¥ã€‚è¯·ç¨åŽå†è¯•ã€?";break;case plupload.FILE_SIZE_ERROR:var o=n.getOption&&n.getOption("max_file_size");o=o||n.settings&&n.settings.max_file_size,i="æµè§ˆå™¨æœ€å¤§å¯ä¸Šä¼ "+o+"ã€‚æ›´å¤§æ–‡ä»¶è¯·ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ã??";break;case plupload.FILE_EXTENSION_ERROR:i="æ–‡ä»¶éªŒè¯å¤±è´¥ã€‚è¯·ç¨åŽé‡è¯•ã€?";break;case plupload.HTTP_ERROR:var u=e.parseJSON(r.response),a=u.error;switch(r.status){case 400:i="è¯·æ±‚æŠ¥æ–‡æ ¼å¼é”™è¯¯ã€?";break;case 401:i="å®¢æˆ·ç«¯è®¤è¯æŽˆæƒå¤±è´¥ã?‚è¯·é‡è¯•æˆ–æäº¤åé¦ˆã??";break;case 405:i="å®¢æˆ·ç«¯è¯·æ±‚é”™è¯¯ã?‚è¯·é‡è¯•æˆ–æäº¤åé¦ˆã??";break;case 579:i="èµ„æºä¸Šä¼ æˆåŠŸï¼Œä½†å›žè°ƒå¤±è´¥ã€?";break;case 599:i="ç½‘ç»œè¿žæŽ¥å¼‚å¸¸ã€‚è¯·é‡è¯•æˆ–æäº¤åé¦ˆã??";break;case 614:i="æ–‡ä»¶å·²å­˜åœ¨ã??";try{u=e.parseJSON(u.error),a=u.error||"file exists"}catch(l){a=u.error||"file exists"}break;case 631:i="æŒ‡å®šç©ºé—´ä¸å­˜åœ¨ã??";break;case 701:i="ä¸Šä¼ æ•°æ®å—æ ¡éªŒå‡ºé”™ã?‚è¯·é‡è¯•æˆ–æäº¤åé¦ˆã??";break;default:i="æœªçŸ¥é”™è¯¯ã€?"}i=i+"("+r.status+"ï¼?"+a+")";break;case plupload.SECURITY_ERROR:i="å®‰å…¨é…ç½®é”™è¯¯ã€‚è¯·è”ç³»ç½‘ç«™ç®¡ç†å‘˜ã??";break;case plupload.GENERIC_ERROR:i="ä¸Šä¼ å¤±è´¥ã€‚è¯·ç¨åŽå†è¯•ã€?";break;case plupload.IO_ERROR:i="ä¸Šä¼ å¤±è´¥ã€‚è¯·ç¨åŽå†è¯•ã€?";break;case plupload.INIT_ERROR:i="ç½‘ç«™é…ç½®é”™è¯¯ã€‚è¯·è”ç³»ç½‘ç«™ç®¡ç†å‘˜ã??",f.destroy();break;default:i=r.message+r.details}t&&t(n,r,i)}n.refresh()}}(r)),f.bind("FileUploaded",function(n){return function(r,i,o){var u=function(r,i,s){if(t.downtoken_url){var o=e.createAjax();o.open("POST",t.downtoken_url,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(o.readyState===4)if(o.status===200){var t;try{t=e.parseJSON(o.responseText)}catch(u){throw"invalid json format"}var a={};plupload.extend(a,e.parseJSON(s),t),n&&n(r,i,JSON.stringify(a))}else f.trigger("Error",{status:o.status,response:o.responseText,file:i,code:plupload.HTTP_ERROR})},o.send("key="+e.parseJSON(s).key+"&domain="+t.domain)}else n&&n(r,i,s)},l=e.parseJSON(o.response);s=s?s:l.ctx;if(s){var c="";t.save_key||(c=a(r,i,e.key_handler),c=c?"/key/"+e.URLSafeBase64Encode(c):"");var h=t.x_vars,p="",d="";if(h!==undefined&&typeof h=="object")for(var v in h)h.hasOwnProperty(v)&&(typeof h[v]=="function"?p=e.URLSafeBase64Encode(h[v](r,i)):typeof h[v]!="object"&&(p=e.URLSafeBase64Encode(h[v])),d+="/x:"+v+"/"+p);var m="http://up.qiniu.com/mkfile/"+i.size+c+d,g=e.createAjax();g.open("POST",m,!0),g.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),g.setRequestHeader("Authorization","UpToken "+e.token),g.onreadystatechange=function(){if(g.readyState===4){localStorage.removeItem(i.name);if(g.status===200){var e=g.responseText;u(r,i,e)}else f.trigger("Error",{status:g.status,response:g.responseText,file:i,code:-200})}},g.send(s)}else u(r,i,o.response)}}(i)),f},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return t.slice(t.length-1)!=="/"&&(t+="/"),t+e},this.imageView2=function(e,t){var n=e.mode||"",r=e.w||"",i=e.h||"",s=e.quality||"",o=e.format||"";if(!n)return!1;if(!r&&!i)return!1;var u="imageView2/"+n;return u+=r?"/w/"+r:"",u+=i?"/h/"+i:"",u+=s?"/q/"+s:"",u+=o?"/format/"+o:"",t&&(u=this.getUrl(t)+"?"+u),u},this.imageMogr2=function(e,t){var n=e["auto-orient"]||"",r=e.thumbnail||"",i=e.strip||"",s=e.gravity||"",o=e.crop||"",u=e.quality||"",a=e.rotate||"",f=e.format||"",l=e.blur||"",c="imageMogr2";return c+=n?"/auto-orient":"",c+=r?"/thumbnail/"+r:"",c+=i?"/strip":"",c+=s?"/gravity/"+s:"",c+=u?"/quality/"+u:"",c+=o?"/crop/"+o:"",c+=a?"/rotate/"+a:"",c+=f?"/format/"+f:"",c+=l?"/blur/"+l:"",t&&(c=this.getUrl(t)+"?"+c),c},this.watermark=function(e,t){var n=e.mode;if(!n)return!1;var r="watermark/"+n;if(n===1){var i=e.image||"";if(!i)return!1;r+=i?"/image/"+this.URLSafeBase64Encode(i):""}else{if(n!==2)return!1;var s=e.text?e.text:"",o=e.font?e.font:"",u=e.fontsize?e.fontsize:"",a=e.fill?e.fill:"";if(!s)return!1;r+=s?"/text/"+this.URLSafeBase64Encode(s):"",r+=o?"/font/"+this.URLSafeBase64Encode(o):"",r+=u?"/fontsize/"+u:"",r+=a?"/fill/"+this.URLSafeBase64Encode(a):""}var f=e.dissolve||"",l=e.gravity||"",c=e.dx||"",h=e.dy||"";return r+=f?"/dissolve/"+f:"",r+=l?"/gravity/"+l:"",r+=c?"/dx/"+c:"",r+=h?"/dy/"+h:"",t&&(r=this.getUrl(t)+"?"+r),r},this.imageInfo=function(e){if(!e)return!1;var t=this.getUrl(e)+"?imageInfo",n=this.createAjax(),r,i=this;return n.open("GET",t,!1),n.onreadystatechange=function(){n.readyState===4&&n.status===200&&(r=i.parseJSON(n.responseText))},n.send(),r},this.exif=function(e){if(!e)return!1;var t=this.getUrl(e)+"?exif",n=this.createAjax(),r,i=this;return n.open("GET",t,!1),n.onreadystatechange=function(){n.readyState===4&&n.status===200&&(r=i.parseJSON(n.responseText))},n.send(),r},this.get=function(e,t){return!t||!e?!1:e==="exif"?this.exif(t):e==="imageInfo"?this.imageInfo(t):!1},this.pipeline=function(e,t){var n=Object.prototype.toString.call(e)==="[object Array]",r,i,s="";if(n){for(var o=0,u=e.length;o<u;o++){r=e[o];if(!r.fop)return!1;switch(r.fop){case"watermark":s+=this.watermark(r)+"|";break;case"imageView2":s+=this.imageView2(r)+"|";break;case"imageMogr2":s+=this.imageMogr2(r)+"|";break;default:i=!0}if(i)return!1}if(t){s=this.getUrl(t)+"?"+s;var a=s.length;s.slice(a-1)==="|"&&(s=s.slice(0,a-1))}return s}return!1}}var Qiniu=new QiniuJsSDK;