/*!
 * WYSIWYG UBB Editor support for xhEditor
 * @requires xhEditor
 * 
 * @author Yanis.Wang<yanis.wang@gmail.com>
 * @site http://xheditor.com/
 * @licence LGPL(http://www.opensource.org/licenses/lgpl-license.php)
 * 
 * @Version: 0.9.12 (build 120228)
 */

function ubb2html(e){function o(e){return e!=null&&e!=""?!isNaN(e):!1}var t,n=String(e),r=new Array,i=0,s=["10px","13px","16px","18px","24px","32px","48px"];n=n.replace(/[<>&"]/g,function(e){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[e]}),n=n.replace(/\r?\n/g,"<br />"),n=n.replace(/\[code\s*(?:=\s*([^\]]+?))?\]([\s\S]*?)\[\/code\]/ig,function(e,t,n){return i++,r[i]=e,"[	ubbcodeplace_"+i+"	]"}),n=n.replace(/\[(\/?)(b|u|i|s|sup|sub)\]/ig,"<$1$2>"),n=n.replace(/\[color\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\]/ig,'<font color="$1">'),n=n.replace(/\[font\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\]/ig,'<font face="$1">'),n=n.replace(/\[\/(color|font)\]/ig,"</font>"),n=n.replace(/\[size\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\]/ig,function(e,t){return t.match(/^\d+$/)&&(t=s[t-1]),'<span style="font-size:'+t+';">'}),n=n.replace(/\[back\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\]/ig,'<span style="background-color:$1;">'),n=n.replace(/\[\/(size|back)\]/ig,"</span>");for(t=0;t<3;t++)n=n.replace(/\[align\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\](((?!\[align(?:\s+[^\]]+)?\])[\s\S])*?)\[\/align\]/ig,'<p align="$1">$2</p>');n=n.replace(/\[img\]\s*(((?!")[\s\S])+?)(?:"[\s\S]*?)?\s*\[\/img\]/ig,'<img src="$1" alt="" />'),n=n.replace(/\[img\s*=([^,\]]*)(?:\s*,\s*(\d*%?)\s*,\s*(\d*%?)\s*)?(?:,?\s*(\w+))?\s*\]\s*(((?!")[\s\S])+?)(?:"[\s\S]*)?\s*\[\/img\]/ig,function(e,t,n,r,i,s){var u='<img src="'+s+'" alt="'+t+'"',a=i?i:o(n)?"":n;return o(n)&&(u+=' width="'+n+'"'),o(r)&&(u+=' height="'+r+'"'),a&&(u+=' align="'+a+'"'),u+=" />",u}),n=n.replace(/\[emot\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\/\]/ig,'<img emot="$1" />'),n=n.replace(/\[url\]\s*(((?!")[\s\S])*?)(?:"[\s\S]*?)?\s*\[\/url\]/ig,'<a href="$1">$1</a>'),n=n.replace(/\[url\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\]\s*([\s\S]*?)\s*\[\/url\]/ig,'<a href="$1">$2</a>'),n=n.replace(/\[email\]\s*(((?!")[\s\S])+?)(?:"[\s\S]*?)?\s*\[\/email\]/ig,'<a href="mailto:$1">$1</a>'),n=n.replace(/\[email\s*=\s*([^\]"]+?)(?:"[^\]]*?)?\s*\]\s*([\s\S]+?)\s*\[\/email\]/ig,'<a href="mailto:$1">$2</a>'),n=n.replace(/\[quote\]/ig,"<blockquote>"),n=n.replace(/\[\/quote\]/ig,"</blockquote>"),n=n.replace(/\[flash\s*(?:=\s*(\d+)\s*,\s*(\d+)\s*)?\]\s*(((?!")[\s\S])+?)(?:"[\s\S]*?)?\s*\[\/flash\]/ig,function(e,t,n,r){return t||(t=480),n||(n=400),'<embed type="application/x-shockwave-flash" src="'+r+'" wmode="opaque" quality="high" bgcolor="#ffffff" menu="false" play="true" loop="true" width="'+t+'" height="'+n+'"/>'}),n=n.replace(/\[media\s*(?:=\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d+)\s*)?)?\]\s*(((?!")[\s\S])+?)(?:"[\s\S]*?)?\s*\[\/media\]/ig,function(e,t,n,r,i){return t||(t=480),n||(n=400),'<embed type="application/x-mplayer2" src="'+i+'" enablecontextmenu="false" autostart="'+(r=="1"?"true":"false")+'" width="'+t+'" height="'+n+'"/>'}),n=n.replace(/\[table\s*(?:=\s*(\d{1,4}%?)\s*(?:,\s*([^\]"]+)(?:"[^\]]*?)?)?)?\s*\]/ig,function(e,t,n){var r="<table";return t&&(r+=' width="'+t+'"'),n&&(r+=' bgcolor="'+n+'"'),r+">"}),n=n.replace(/\[tr\s*(?:=\s*([^\]"]+?)(?:"[^\]]*?)?)?\s*\]/ig,function(e,t){return"<tr"+(t?' bgcolor="'+t+'"':"")+">"}),n=n.replace(/\[td\s*(?:=\s*(\d{1,2})\s*,\s*(\d{1,2})\s*(?:,\s*(\d{1,4}%?))?)?\s*\]/ig,function(e,t,n,r){return"<td"+(t>1?' colspan="'+t+'"':"")+(n>1?' rowspan="'+n+'"':"")+(r?' width="'+r+'"':"")+">"}),n=n.replace(/\[\/(table|tr|td)\]/ig,"</$1>"),n=n.replace(/\[\*\]((?:(?!\[\*\]|\[\/list\]|\[list\s*(?:=[^\]]+)?\])[\s\S])+)/ig,"<li>$1</li>"),n=n.replace(/\[list\s*(?:=\s*([^\]"]+?)(?:"[^\]]*?)?)?\s*\]/ig,function(e,t){var n="<ul";return t&&(n+=' type="'+t+'"'),n+">"}),n=n.replace(/\[\/list\]/ig,"</ul>"),n=n.replace(/\[hr\/\]/ig,"<hr />");for(t=1;t<=i;t++)n=n.replace("[	ubbcodeplace_"+t+"	]",r[t]);return n=n.replace(/(^|<\/?\w+(?:\s+[^>]*?)?>)([^<$]+)/ig,function(e,t,n){return t+n.replace(/[\t ]/g,function(e){return{"	":"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"," ":"&nbsp;"}[e]})}),n}function html2ubb(e){function f(e,t,n,r){if(!n)return r;var i=[],s=[],o;return o=n.match(/ face\s*=\s*"\s*([^"]+)\s*"/i),o&&(i.push("[font="+o[1]+"]"),s.push("[/font]")),o=n.match(/ size\s*=\s*"\s*(\d+)\s*"/i),o&&(i.push("[size="+o[1]+"]"),s.push("[/size]")),o=n.match(/ color\s*=\s*"\s*([^"]+)\s*"/i),o&&(i.push("[color="+l(o[1])+"]"),s.push("[/color]")),i.join("")+r+s.join("")}function l(e){var t;if(t=e.match(/\s*rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i)){e=(t[1]*65536+t[2]*256+t[3]*1).toString(16);while(e.length<6)e="0"+e;e="#"+e}return e=e.replace(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i,"#$1$1$2$2$3$3"),e}var t=/\s+src\s*=\s*(["']?)\s*(.+?)\s*\1(\s|$)/i,n=/\s+width\s*=\s*(["']?)\s*(\d+(?:\.\d+)?%?)\s*\1(\s|$)/i,r=/\s+height\s*=\s*(["']?)\s*(\d+(?:\.\d+)?%?)\s*\1(\s|$)/i,i=/(?:background|background-color|bgcolor)\s*[:=]\s*(["']?)\s*((rgb\s*\(\s*\d{1,3}%?,\s*\d{1,3}%?\s*,\s*\d{1,3}%?\s*\))|(#[0-9a-f]{3,6})|([a-z]{1,20}))\s*\1/i,s,o=String(e),u=new Array,a=0;o=o.replace(/[ \t]*\r?\n[ \t]*/g,""),o=o.replace(/<(script|style)(\s+[^>]*?)?>[\s\S]*?<\/\1>/ig,""),o=o.replace(/<!--[\s\S]*?-->/ig,""),o=o.replace(/<br(\s+[^>]*)?\/?>/ig,"\r\n"),o=o.replace(/\[code\s*(=\s*([^\]]+?))?\]([\s\S]*?)\[\/code\]/ig,function(e,t,n){return a++,u[a]=e,"[	ubbcodeplace_"+a+"	]"}),o=o.replace(/<(\/?)(b|u|i|s)(\s+[^>]*?)?>/ig,"[$1$2]"),o=o.replace(/<(\/?)strong(\s+[^>]*?)?>/ig,"[$1b]"),o=o.replace(/<(\/?)em(\s+[^>]*?)?>/ig,"[$1i]"),o=o.replace(/<(\/?)(strike|del)(\s+[^>]*?)?>/ig,"[$1s]"),o=o.replace(/<(\/?)(sup|sub)(\s+[^>]*?)?>/ig,"[$1$2]"),o=o.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,f),o=o.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?)<\/\1>/ig,f),o=o.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S])*?)<\/\1>/ig,f);for(s=0;s<3;s++)o=o.replace(/<(span)(?:\s+[^>]*?)?\s+style\s*=\s*"((?:[^"]*?;)*\s*(?:font-family|font-size|color|background|background-color)\s*:[^"]*)"(?: [^>]+)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,function(e,t,n,r){var i=n.match(/(?:^|;)\s*font-family\s*:\s*([^;]+)/i),s=n.match(/(?:^|;)\s*font-size\s*:\s*([^;]+)/i),o=n.match(/(?:^|;)\s*color\s*:\s*([^;]+)/i),u=n.match(/(?:^|;)\s*(?:background|background-color)\s*:\s*([^;]+)/i),a=r,f=[],c=[];return i&&(f.push("[font="+i[1]+"]"),c.push("[/font]")),s&&(f.push("[size="+s[1]+"]"),c.push("[/size]")),o&&(f.push("[color="+l(o[1])+"]"),c.push("[/color]")),u&&(f.push("[back="+l(u[1])+"]"),c.push("[/back]")),f.join("")+a+c.join("")});for(s=0;s<3;s++)o=o.replace(/<(div|p)(?:\s+[^>]*?)?[\s"';]\s*(?:text-)?align\s*[=:]\s*(["']?)\s*(left|center|right)\s*\2[^>]*>(((?!<\1(\s+[^>]*?)?>)[\s\S])+?)<\/\1>/ig,"[align=$3]$4[/align]");for(s=0;s<3;s++)o=o.replace(/<(center)(?:\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S])*?)<\/\1>/ig,"[align=center]$2[/align]");for(s=0;s<3;s++)o=o.replace(/<(p|div)(?:\s+[^>]*?)?\s+style\s*=\s*"(?:[^;"]*;)*\s*text-align\s*:([^;"]*)[^"]*"(?: [^>]+)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,function(e,t,n,r){return"[align="+n+"]"+r+"[/align]"});o=o.replace(/<a(?:\s+[^>]*?)?\s+href=(["'])\s*(.+?)\s*\1[^>]*>\s*([\s\S]*?)\s*<\/a>/ig,function(e,t,n,r){if(!n||!r)return"";var i="url",s;return n.match(/^mailto:/i)&&(i="email",n=n.replace(/mailto:(.+?)/i,"$1")),s="["+i,n!=r&&(s+="="+n),s+"]"+r+"[/"+i+"]"}),o=o.replace(/<img(\s+[^>]*?)\/?>/ig,function(e,i){var s=i.match(/\s+emot\s*=\s*(["']?)\s*(.+?)\s*\1(\s|$)/i);if(s)return"[emot="+s[2]+"/]";var o=i.match(t),u=i.match(/\s+alt\s*=\s*(["']?)\s*(.*?)\s*\1(\s|$)/i),a=i.match(n),f=i.match(r),l=i.match(/\s+align\s*=\s*(["']?)\s*(\w+)\s*\1(\s|$)/i),c="[img",h="";if(!o)return"";h+=u[2];if(a||f)h+=","+(a?a[2]:"")+","+(f?f[2]:"");return l&&(h+=","+l[2]),h&&(c+="="+h),c+="]"+o[2]+"[/img]",c}),o=o.replace(/<blockquote(?:\s+[^>]*?)?>/ig,"[quote]"),o=o.replace(/<\/blockquote>/ig,"[/quote]"),o=o.replace(/<embed((?:\s+[^>]*?)?(?:\s+type\s*=\s*"\s*application\/x-shockwave-flash\s*"|\s+classid\s*=\s*"\s*clsid:d27cdb6e-ae6d-11cf-96b8-4445535400000\s*")[^>]*?)\/?>/ig,function(e,i){var s=i.match(t),o=i.match(n),u=i.match(r),a="[flash";return s?(o&&u&&(a+="="+o[2]+","+u[2]),a+="]"+s[2],a+"[/flash]"):""}),o=o.replace(/<embed((?:\s+[^>]*?)?(?:\s+type\s*=\s*"\s*application\/x-mplayer2\s*"|\s+classid\s*=\s*"\s*clsid:6bf52a52-394a-11d3-b153-00c04f79faa6\s*")[^>]*?)\/?>/ig,function(e,i){var s=i.match(t),o=i.match(n),u=i.match(r),a=i.match(/\s+autostart\s*=\s*(["']?)\s*(.+?)\s*\1(\s|$)/i),f="[media",l="0";return s?(a&&a[2]=="true"&&(l="1"),o&&u&&(f+="="+o[2]+","+u[2]+","+l),f+="]"+s[2],f+"[/media]"):""}),o=o.replace(/<table(\s+[^>]*?)?>/ig,function(e,t){var r="[table";if(t){var s=t.match(n),o=t.match(i);s&&(r+="="+s[2],o&&(r+=","+o[2]))}return r+"]"}),o=o.replace(/<tr(\s+[^>]*?)?>/ig,function(e,t){var n="[tr";if(t){var r=t.match(i);r&&(n+="="+r[2])}return n+"]"}),o=o.replace(/<(?:th|td)(\s+[^>]*?)?>/ig,function(e,t){var r="[td";if(t){var i=t.match(/\s+colspan\s*=\s*(["']?)\s*(\d+)\s*\1(\s|$)/i),s=t.match(/\s+rowspan\s*=\s*(["']?)\s*(\d+)\s*\1(\s|$)/i),o=t.match(n);i=i?i[2]:1,s=s?s[2]:1;if(i>1||s>1||o)r+="="+i+","+s;o&&(r+=","+o[2])}return r+"]"}),o=o.replace(/<\/(table|tr)>/ig,"[/$1]"),o=o.replace(/<\/(th|td)>/ig,"[/td]"),o=o.replace(/<ul(\s+[^>]*?)?>/ig,function(e,t){var n;return t&&(n=t.match(/\s+type\s*=\s*(["']?)\s*(.+?)\s*\1(\s|$)/i)),"[list"+(n?"="+n[2]:"")+"]"}),o=o.replace(/<ol(\s+[^>]*?)?>/ig,"[list=1]"),o=o.replace(/<li(\s+[^>]*?)?>/ig,"[*]"),o=o.replace(/<\/li>/ig,""),o=o.replace(/<\/(ul|ol)>/ig,"[/list]"),o=o.replace(/<h([1-6])(\s+[^>]*?)?>/ig,function(e,t){return"\r\n\r\n[size="+(7-t)+"][b]"}),o=o.replace(/<\/h[1-6]>/ig,"[/b][/size]\r\n\r\n"),o=o.replace(/<address(\s+[^>]*?)?>/ig,"\r\n[i]"),o=o.replace(/<\/address>/ig,"[i]\r\n"),o=o.replace(/<hr(\s+[^>]*?)?\/>/ig,"[hr/]");for(s=0;s<3;s++)o=o.replace(/<(p)(?:\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,"\r\n\r\n$2\r\n\r\n");for(s=0;s<3;s++)o=o.replace(/<(div)(?:\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,"\r\n$2\r\n");o=o.replace(/((\s|&nbsp;)*\r?\n){3,}/g,"\r\n\r\n"),o=o.replace(/^((\s|&nbsp;)*\r?\n)+/g,""),o=o.replace(/((\s|&nbsp;)*\r?\n)+$/g,"");for(s=1;s<=a;s++)o=o.replace("[	ubbcodeplace_"+s+"	]",u[s]);o=o.replace(/<[^<>]+?>/g,"");var c={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return o=o.replace(/&(lt|gt|nbsp|amp|quot);/ig,function(e,t){return c[t]}),o=o.replace(/\[([a-z]+)(?:=[^\[\]]+)?\]\s*\[\/\1\]/ig,""),o};