function HTML2Markdown(e,t){function c(){var e="";if(i)for(var t=0;t<i.length-1;t++)e+="  ";return e+=p(i),e}function h(e){var t={};for(var n in e){var r=e[n];t[r.name]=r}return t}function p(e){return e&&e.length>0?e.slice(-1)[0]:""}function d(e){if(!e)return"";for(var t=e.length-1;t>=0;t--)if(e[t]!="")return e[t];return""}function v(e){var t=!1;if(e==d(r)){while(p(r)!=e)r.pop();r.pop(),t=!0}return t}function m(e){var t=[];while(r.length>0&&p(r)!=e){var n=r.pop();t.unshift(n)}return t.join("")}function g(e){var t=r.pop();if(!t)return;if(!e){var n;/\s*\n\n\s*$/.test(t)?(t=t.replace(/\s*\n\n\s*$/,"\n\n"),n=""):/\s*\n\s*$/.test(t)?(t=t.replace(/\s*\n\s*$/,"\n"),n="\n"):/\s+$/.test(t)?n="\n\n":n="\n\n",r.push(t),r.push(n)}else r.push(t),t.endsWith("\n")||r.push("\n\n")}function y(){if(r.length>0){var e=p(r);e.endsWith("\n")||r.push("\n")}else r.push("\n")}var n=!1,r=[],i=[],s=[],o=[],u=[],a=[];t=t||{};var f=t.inlineStyle||!1,l={hr:"- - -\n\n",br:"  \n",title:"# ",h1:"# ",h2:"## ",h3:"### ",h4:"#### ",h5:"##### ",h6:"###### ",b:"**",strong:"**",i:"_",em:"_",dfn:"_","var":"_",cite:"_",span:" ",ul:"* ",ol:"1. ",dl:"- ",blockquote:"> "};try{var b;if(e){var w=document.createElement("div");w.innerHTML=e,b=w}else b=window.document.body;HTMLParser(b,{start:function(e,t,v){e=e.toLowerCase(),n&&console.log("start: "+e);if(v&&e!="br"&&e!="hr"&&e!="img")return;switch(e){case"br":r.push(l[e]);break;case"hr":g(),r.push(l[e]);break;case"title":case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":g(),r.push(l[e]);break;case"b":case"strong":case"i":case"em":case"dfn":case"var":case"cite":r.push(l[e]);break;case"span":/\s+$/.test(p(r))||r.push(l[e]);break;case"p":case"div":case"td":g();break;case"ul":case"ol":case"dl":i.push(l[e]),i.length>1?y():g();break;case"li":case"dt":var m=c();r.push(m);break;case"a":var b=h(t);s.push(b),r.push("[");break;case"img":var b=h(t),w,E,S;b.src?S=getNormalizedUrl(b.src.value):S="";if(!S)break;b.alt?w=b.alt.value.trim():w="",b.title?E=b.title.value.trim():E="";if(!f&&!d(r).startsWith("[")){var x=a.indexOf(S);x==-1&&(a.push(S),x=a.length-1),g(),r.push("!["),w!=""?r.push(w):E!=null&&r.push(E),r.push("]["+x+"]"),g()}else d(r).startsWith("[")||g(),r.push("!["+w+"]("+S+(E?' "'+E+'"':"")+")"),d(r).startsWith("[")||g(!0);break;case"blockquote":g(),o.push(l[e]),r.push(o.join(""));break;case"pre":case"code":g(),u.push(!0)}},chars:function(e){if(u.length>0)e="    "+e.replace(/\n/g,"\n    ");else{if(e.trim()==""){r.push("");return}e=e.replace(/\s+/g," ");var t=d(r);/\s+$/.test(t)&&(e=e.replace(/^\s+/g,""))}n&&console.log("text: "+e),r.push(e)},end:function(e){e=e.toLowerCase(),n&&console.log("end: "+e);switch(e){case"title":case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":v(l[e])||g(!0);break;case"p":case"div":case"td":while(r.length>0&&p(r).trim()=="")r.pop();g(!0);break;case"b":case"strong":case"i":case"em":case"dfn":case"var":case"cite":v(l[e])||(r.push(m(l[e]).trim()),r.push(l[e]));break;case"a":var t=m("[");t=t.replace(/\s+/g," "),t=t.trim();if(t==""){r.pop();break}var h=s.pop(),d;h.href&&h["href"].value!=""?d=getNormalizedUrl(h.href.value):d="";if(d==""){r.pop(),r.push(t);break}r.push(t);if(!f&&!p(r).startsWith("!")){var b=a.indexOf(d);b==-1&&(a.push(d),b=a.length-1),r.push("]["+b+"]")}else{if(p(r).startsWith("!")){var t=r.pop();t=r.pop()+t,g(),r.push(t)}var w=h.title;r.push("]("+d+(w?' "'+w.value.trim().replace(/\s+/g," ")+'"':"")+")"),p(r).startsWith("!")&&g(!0)}break;case"ul":case"ol":case"dl":y(),i.pop();break;case"li":case"dt":var E=c();if(!v(E)){var t=m(E).trim();t.startsWith("[![")?(r.pop(),g(),r.push(t),g(!0)):(r.push(t),y())}break;case"blockquote":o.pop();break;case"pre":case"code":g(!0),u.pop();break;case"span":if(p(r).trim()=="")r.pop(),p(r)==" "?r.pop():r.push(l[e]);else{var t=r.pop();r.push(t.trim()),r.push(l[e])}break;case"br":case"hr":case"img":case"table":case"tr":}}},{nodesToIgnore:["script","noscript","object","iframe","frame","head","style","label"]});if(!f)for(var E=0;E<a.length;E++)if(E==0){var S=r.pop();r.push(S.replace(/\s+$/g,"")),r.push("\n\n["+E+"]: "+a[E])}else r.push("\n["+E+"]: "+a[E])}catch(w){console.log(w.stack),console.trace()}return r.join("")}function getNormalizedUrl(e){var t=location.href,n=t.replace(/\/[^\/]*$/,"/"),r=t.replace(/#[^\/#]*$/,""),i;return/^[a-zA-Z]([a-zA-Z0-9 -.])*:/.test(e)?i=e:/^\x2f/.test(e)?(location.protocol!=""?i=location.protocol+"//":i="",i+=location.hostname,location.port!="80"&&(i+=":"+location.port),i+=e):/^#/.test(e)?i=r+e:i=n+e,encodeURI(i)}if(typeof require!="undefined")var htmlparser=require("./htmldomparser"),HTMLParser=htmlparser.HTMLParser;typeof exports!="undefined"&&(exports.HTML2Markdown=HTML2Markdown),typeof exports!="undefined"&&(exports.HTML2MarkDown=HTML2MarkDown),typeof String.prototype.trim!="function"&&(String.prototype.trim=function(){return replace(/^\s+|\s+$/g,"")}),typeof String.prototype.isNotEmpty!="function"&&(String.prototype.isNotEmpty=function(){return/\S/.test(this)?!0:!1}),typeof String.prototype.replaceAll!="function"&&(String.prototype.replaceAll=function(e,t){var n=this,r=n.indexOf(e);while(r!=-1)n=n.replace(e,t),r=n.indexOf(e);return n}),typeof String.prototype.startsWith!="function"&&(String.prototype.startsWith=function(e){return this.indexOf(e)==0}),typeof String.prototype.endsWith!="function"&&(String.prototype.endsWith=function(e){return this.match(e+"$")==e}),typeof Array.prototype.indexOf!="function"&&(Array.prototype.indexOf=function(e,t){t==null?t=0:t<0&&(t=Math.max(0,this.length+t));for(var n=t,r=this.length;n<r;n++)if(this[n]===e)return n;return-1});